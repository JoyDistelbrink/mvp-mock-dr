<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NeoBank - DR Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        border: "hsl(var(--border))",
                        input: "hsl(var(--input))",
                        ring: "hsl(var(--ring))",
                        background: "hsl(var(--background))",
                        foreground: "hsl(var(--foreground))",
                        primary: {
                            DEFAULT: "hsl(222.2 47.4% 11.2%)",
                            foreground: "hsl(210 40% 98%)",
                        },
                        destructive: {
                            DEFAULT: "hsl(0 62.8% 30.6%)",
                            foreground: "hsl(210 40% 98%)",
                        },
                        muted: {
                            DEFAULT: "hsl(210 40% 96.1%)",
                            foreground: "hsl(215.4 16.3% 46.9%)",
                        },
                        accent: {
                            DEFAULT: "hsl(210 40% 96.1%)",
                            foreground: "hsl(222.2 47.4% 11.2%)",
                        },
                    }
                }
            }
        }
    </script>
    <style>
        /* Custom scrollbar for a cleaner look */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
    </style>
</head>

<body class="bg-gray-50 text-gray-900 font-sans antialiased">

    <!-- Error Detail Modal -->
    <div id="error-modal" class="fixed inset-0 z-50 hidden">
        <div class="fixed inset-0 bg-black/50 backdrop-blur-sm" onclick="closeErrorModal()"></div>
        <div class="fixed left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 w-full max-w-lg">
            <div class="bg-white rounded-lg shadow-lg border mx-4">
                <div class="flex items-center justify-between p-4 border-b">
                    <h3 class="text-sm font-semibold text-gray-900" id="modal-title">Error Details</h3>
                    <button onclick="closeErrorModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
                        <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                <div class="p-4 max-h-[60vh] overflow-auto">
                    <pre id="modal-content"
                        class="text-xs font-mono text-red-800 bg-red-50 p-3 rounded-md border border-red-100 whitespace-pre-wrap break-all"></pre>
                </div>
                <div class="p-4 border-t bg-gray-50 rounded-b-lg">
                    <button onclick="closeErrorModal()"
                        class="w-full px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50 transition-colors">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="fixed inset-0 z-50 hidden">
        <div class="fixed inset-0 bg-black/50 backdrop-blur-sm" onclick="closeSettingsModal()"></div>
        <div class="fixed left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 w-full max-w-md">
            <div class="bg-white rounded-lg shadow-lg border mx-4">
                <div class="flex items-center justify-between p-4 border-b">
                    <h3 class="text-sm font-semibold text-gray-900">Settings</h3>
                    <button onclick="closeSettingsModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
                        <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                <div class="p-6 space-y-4">
                    <div class="flex items-center justify-between">
                        <div>
                            <h4 class="text-sm font-medium text-gray-900">VM Monitoring</h4>
                            <p class="text-xs text-gray-500">Enable monitoring for Virtual Machine</p>
                        </div>
                        <div class="flex items-center">
                            <span id="setting-check-vm"
                                class="inline-flex items-center rounded-full bg-gray-100 px-2.5 py-0.5 text-xs font-medium text-gray-800">
                                Disabled
                            </span>
                        </div>
                    </div>
                    <div class="pt-4 border-t">
                        <h4 class="text-xs font-medium text-gray-500 uppercase tracking-wider mb-2">Configuration</h4>
                        <dl class="grid grid-cols-1 gap-x-4 gap-y-4 sm:grid-cols-2">
                            <div class="sm:col-span-2">
                                <dt class="text-xs font-medium text-gray-500">VM Host</dt>
                                <dd class="mt-1 text-sm text-gray-900 font-mono bg-gray-50 p-2 rounded border"
                                    id="setting-vm-host">--</dd>
                            </div>
                        </dl>
                    </div>
                </div>
                <div class="p-4 border-t bg-gray-50 rounded-b-lg">
                    <button onclick="closeSettingsModal()"
                        class="w-full px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50 transition-colors">Close</button>
                </div>
            </div>
        </div>
    </div>

    <div class="flex h-screen overflow-hidden">

        <!-- Sidebar -->
        <aside class="hidden w-64 overflow-y-auto border-r bg-white md:block">
            <div class="flex h-16 items-center justify-center border-b px-6">
                <span class="text-lg font-bold tracking-tight text-gray-900">NeoBank Corp</span>
            </div>
            <div class="p-4 space-y-2">
                <a href="#"
                    class="flex items-center rounded-lg bg-gray-100 px-4 py-2.5 text-sm font-medium text-gray-900">
                    <svg class="mr-3 h-5 w-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z">
                        </path>
                    </svg>
                    Dashboard
                </a>
                <a href="#" onclick="openSettingsModal(); return false;"
                    class="flex items-center rounded-lg px-4 py-2.5 text-sm font-medium text-gray-600 hover:bg-gray-50 hover:text-gray-900">
                    <svg class="mr-3 h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z">
                        </path>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                    </svg>
                    Settings
                </a>
            </div>
        </aside>

        <!-- Main Content -->
        <div class="flex flex-1 flex-col overflow-hidden">
            <!-- Header -->
            <header class="flex h-16 items-center justify-between border-b bg-white px-6">
                <h1 class="text-2xl font-semibold text-gray-900">System Overview</h1>
                <div class="flex items-center space-x-4">
                    <!-- Custom Dropdown -->
                    <div class="relative" id="poll-dropdown">
                        <button type="button" id="poll-dropdown-btn"
                            class="inline-flex items-center gap-2 rounded-md border border-gray-200 bg-white px-3 py-1.5 text-xs font-medium text-gray-700 shadow-sm hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-gray-200 transition-colors">
                            <svg class="h-3.5 w-3.5 text-gray-400" fill="none" stroke="currentColor"
                                viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                            </svg>
                            <span id="poll-dropdown-value">3s</span>
                            <svg class="h-3.5 w-3.5 text-gray-400" fill="none" stroke="currentColor"
                                viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M19 9l-7 7-7-7" />
                            </svg>
                        </button>
                        <div id="poll-dropdown-menu"
                            class="absolute right-0 z-10 mt-1 hidden w-32 origin-top-right rounded-md border border-gray-200 bg-white shadow-lg focus:outline-none">
                            <div class="py-1">
                                <button data-value="1000"
                                    class="poll-option flex w-full items-center px-3 py-1.5 text-xs text-gray-700 hover:bg-gray-100">
                                    <span class="flex-1 text-left">1 second</span>
                                </button>
                                <button data-value="3000"
                                    class="poll-option flex w-full items-center px-3 py-1.5 text-xs text-gray-700 hover:bg-gray-100 bg-gray-50">
                                    <span class="flex-1 text-left">3 seconds</span>
                                    <svg class="h-3.5 w-3.5 text-emerald-500 check-icon" fill="none"
                                        stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M5 13l4 4L19 7" />
                                    </svg>
                                </button>
                                <button data-value="5000"
                                    class="poll-option flex w-full items-center px-3 py-1.5 text-xs text-gray-700 hover:bg-gray-100">
                                    <span class="flex-1 text-left">5 seconds</span>
                                </button>
                                <button data-value="10000"
                                    class="poll-option flex w-full items-center px-3 py-1.5 text-xs text-gray-700 hover:bg-gray-100">
                                    <span class="flex-1 text-left">10 seconds</span>
                                </button>
                            </div>
                        </div>
                    </div>
                    <span
                        class="inline-flex items-center rounded-full bg-emerald-100 px-2.5 py-0.5 text-xs font-medium text-emerald-700"
                        id="app-status-badge">
                        App Online
                    </span>
                </div>
            </header>

            <!-- Main Scrollable Area -->
            <main class="flex-1 overflow-y-auto bg-gray-50 p-6">

                <!-- Status Cards Grid -->
                <div class="grid gap-6 md:grid-cols-3 mb-8">
                    <!-- Postgres Card -->
                    <div class="rounded-xl border bg-white shadow-sm flex flex-col">
                        <div class="p-6 pb-4">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center gap-2">
                                    <h3 class="text-sm font-medium text-gray-500">Database (PostgreSQL)</h3>
                                    <span id="postgres-region-badge"
                                        class="hidden inline-flex items-center rounded-md bg-blue-50 px-1.5 py-0.5 text-[10px] font-medium text-blue-600 ring-1 ring-inset ring-blue-600/10 tracking-wide"></span>
                                </div>
                                <svg class="h-5 w-5 text-gray-400" fill="none" stroke="currentColor"
                                    viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4m0 5c0 2.21-3.582 4-8 4s-8-1.79-8-4">
                                    </path>
                                </svg>
                            </div>
                            <p class="mt-1 text-xs text-gray-400 font-mono truncate" id="postgres-resource">--</p>
                            <div class="mt-3 flex items-baseline">
                                <p class="text-2xl font-semibold text-gray-900" id="postgres-status">Checking...</p>
                            </div>
                            <p class="mt-1 text-sm text-gray-500" id="postgres-latency">Latency: -- ms</p>
                        </div>
                        <div id="postgres-heartbeat" class="mt-auto px-6 pb-4 flex gap-[2px] overflow-hidden"></div>
                    </div>

                    <!-- Storage Card -->
                    <div class="rounded-xl border bg-white shadow-sm flex flex-col">
                        <div class="p-6 pb-4">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center gap-2">
                                    <h3 class="text-sm font-medium text-gray-500">Blob Storage</h3>
                                    <span id="storage-region-badge"
                                        class="hidden inline-flex items-center rounded-md bg-blue-50 px-1.5 py-0.5 text-[10px] font-medium text-blue-600 ring-1 ring-inset ring-blue-600/10 tracking-wide"></span>
                                </div>
                                <svg class="h-5 w-5 text-gray-400" fill="none" stroke="currentColor"
                                    viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10">
                                    </path>
                                </svg>
                            </div>
                            <p class="mt-1 text-xs text-gray-400 font-mono truncate" id="storage-resource">--</p>
                            <div class="mt-3 flex items-baseline">
                                <p class="text-2xl font-semibold text-gray-900" id="storage-status">Checking...</p>
                            </div>
                            <p class="mt-1 text-sm text-gray-500" id="storage-latency">Latency: -- ms</p>
                        </div>
                        <div id="storage-heartbeat" class="mt-auto px-6 pb-4 flex gap-[2px] overflow-hidden"></div>
                    </div>

                    <!-- Key Vault Card -->
                    <div class="rounded-xl border bg-white shadow-sm flex flex-col">
                        <div class="p-6 pb-4">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center gap-2">
                                    <h3 class="text-sm font-medium text-gray-500">Key Vault</h3>
                                    <span id="keyvault-region-badge"
                                        class="hidden inline-flex items-center rounded-md bg-blue-50 px-1.5 py-0.5 text-[10px] font-medium text-blue-600 ring-1 ring-inset ring-blue-600/10 tracking-wide"></span>
                                </div>
                                <svg class="h-5 w-5 text-gray-400" fill="none" stroke="currentColor"
                                    viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z">
                                    </path>
                                </svg>
                            </div>
                            <p class="mt-1 text-xs text-gray-400 font-mono truncate" id="keyvault-resource">--</p>
                            <div class="mt-3 flex items-baseline">
                                <p class="text-2xl font-semibold text-gray-900" id="keyvault-status">Checking...</p>
                            </div>
                            <p class="mt-1 text-sm text-gray-500" id="keyvault-latency">Latency: -- ms</p>
                        </div>
                        <div id="keyvault-heartbeat" class="mt-auto px-6 pb-4 flex gap-[2px] overflow-hidden"></div>
                    </div>

                    <!-- VM Card (Hidden by default) -->
                    <div id="vm-card" class="rounded-xl border bg-white shadow-sm flex flex-col hidden">
                        <div class="p-6 pb-4">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center gap-2">
                                    <h3 class="text-sm font-medium text-gray-500">Virtual Machine</h3>
                                    <span id="vm-region-badge"
                                        class="hidden inline-flex items-center rounded-md bg-blue-50 px-1.5 py-0.5 text-[10px] font-medium text-blue-600 ring-1 ring-inset ring-blue-600/10 tracking-wide"></span>
                                </div>
                                <svg class="h-5 w-5 text-gray-400" fill="none" stroke="currentColor"
                                    viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M5 12h14M5 12a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v4a2 2 0 01-2 2M5 12a2 2 0 00-2 2v4a2 2 0 002 2h14a2 2 0 002-2v-4a2 2 0 00-2-2m-2-4h.01M17 16h.01">
                                    </path>
                                </svg>
                            </div>
                            <p class="mt-1 text-xs text-gray-400 font-mono truncate" id="vm-resource">--</p>
                            <div class="mt-3 flex items-baseline">
                                <p class="text-2xl font-semibold text-gray-900" id="vm-status">Checking...</p>
                            </div>
                            <p class="mt-1 text-sm text-gray-500" id="vm-latency">Latency: -- ms</p>
                        </div>
                        <div id="vm-heartbeat" class="mt-auto px-6 pb-4 flex gap-[2px] overflow-hidden"></div>
                    </div>
                </div>

                <!-- Azure Resources Section -->
                <div class="rounded-xl border bg-white shadow-sm">
                    <div class="border-b px-6 py-4">
                        <h3 class="text-lg font-medium leading-6 text-gray-900">Azure Resources</h3>
                        <p class="mt-1 text-sm text-gray-500">Resources configured for this project.</p>
                    </div>

                    <div id="resources-list" class="divide-y divide-gray-100">
                        <div class="px-6 py-8 text-center text-sm text-gray-500">Loading resources...</div>
                    </div>
                </div>

            </main>
        </div>
    </div>

    <script>
        // Fixed number of heartbeat slots
        const SLOT_COUNT = 20;

        const history = {
            postgres: [],
            storage: [],
            keyvault: [],
            vm: []
        };

        // Initialize heartbeat slots (empty placeholders)
        function initHeartbeat(containerId) {
            const container = document.getElementById(containerId);
            if (!container) return;
            container.innerHTML = '';
            for (let i = 0; i < SLOT_COUNT; i++) {
                const slot = document.createElement('div');
                slot.className = 'w-1.5 h-3 rounded-[2px] bg-zinc-200';
                container.appendChild(slot);
            }
        }

        // Update heartbeat display
        function updateHeartbeat(containerId, historyArray) {
            const container = document.getElementById(containerId);
            if (!container) return;
            const slots = container.children;
            for (let i = 0; i < SLOT_COUNT; i++) {
                if (i < historyArray.length) {
                    const status = historyArray[i];
                    if (status === 'up') {
                        slots[i].className = 'w-1.5 h-3 rounded-[2px] bg-emerald-400';
                    } else if (status === 'down') {
                        slots[i].className = 'w-1.5 h-3 rounded-[2px] bg-red-400';
                    } else {
                        slots[i].className = 'w-1.5 h-3 rounded-[2px] bg-zinc-200';
                    }
                } else {
                    slots[i].className = 'w-1.5 h-3 rounded-[2px] bg-zinc-200';
                }
            }
        }

        // Initialize all heartbeats
        initHeartbeat('postgres-heartbeat');
        initHeartbeat('storage-heartbeat');
        initHeartbeat('keyvault-heartbeat');
        initHeartbeat('vm-heartbeat');

        async function updateStatus() {
            try {
                const response = await fetch('/api/health');
                const data = await response.json();

                // Helper to update UI elements
                const updateCard = (service, elementIdPrefix) => {
                    if (!service) return; // Skip if service data is missing

                    const statusEl = document.getElementById(`${ elementIdPrefix }-status`);
                    const latencyEl = document.getElementById(`${ elementIdPrefix }-latency`);
                    const resourceEl = document.getElementById(`${ elementIdPrefix }-resource`);

                    // Update resource name
                    if (resourceEl) {
                        resourceEl.textContent = service.resource_name || '--';
                        resourceEl.title = service.resource_name || '';
                    }

                    // Update region badge if available
                    const regionBadge = document.getElementById(`${ elementIdPrefix }-region-badge`);
                    if (regionBadge) {
                        if (service.region && service.region !== 'Unknown') {
                            regionBadge.textContent = service.region;
                            regionBadge.classList.remove('hidden');
                        } else {
                            regionBadge.classList.add('hidden');
                        }
                    }

                    // Determine status type
                    let statusType = 'unknown';
                    if (service.status === 'up') statusType = 'up';
                    else if (service.status === 'down' || service.status === 'unreachable') statusType = 'down';

                    // Reset history when full, then add new status
                    if (history[elementIdPrefix].length >= SLOT_COUNT) {
                        history[elementIdPrefix] = [];
                    }
                    history[elementIdPrefix].push(statusType);
                    updateHeartbeat(`${ elementIdPrefix }-heartbeat`, history[elementIdPrefix]);

                    if (service.status === 'up') {
                        statusEl.textContent = 'Online';
                        statusEl.className = 'text-2xl font-semibold text-emerald-600';
                        latencyEl.textContent = `Latency: ${ service.latency_ms } ms`;
                        latencyEl.className = 'mt-1 text-sm text-gray-500';
                    } else if (service.status === 'unknown') {
                        statusEl.textContent = 'Not Configured';
                        statusEl.className = 'text-2xl font-semibold text-gray-400';
                        latencyEl.textContent = 'Latency: --';
                        latencyEl.className = 'mt-1 text-sm text-gray-500';
                    } else {
                        statusEl.textContent = 'Unreachable';
                        statusEl.className = 'text-2xl font-semibold text-red-600';
                        const fullMessage = service.message || 'Unknown error';
                        const truncated = fullMessage.length > 100 ? fullMessage.substring(0, 100) + '...' : fullMessage;
                        const needsExpand = fullMessage.length > 100;

                        // Store full message for modal
                        if (needsExpand) {
                            window.errorMessages = window.errorMessages || {};
                            window.errorMessages[elementIdPrefix] = fullMessage;
                        }

                        latencyEl.innerHTML = `
                            <div class="mt-2 rounded-md bg-red-50 p-2 text-xs font-mono text-red-800 border border-red-100">
                                <p class="line-clamp-2">${ truncated }</p>
                                ${ needsExpand ? `<button onclick="showErrorModal('${ elementIdPrefix }')" class="mt-2 inline-flex items-center gap-1 text-[11px] font-medium text-muted-foreground hover:text-foreground transition-colors">
                                    <svg class="h-3 w-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                    View details
                                </button>` : '' }
                            </div>
                        `;
                        latencyEl.className = 'mt-1';
                    }
                };

                updateCard(data.postgres, 'postgres');
                updateCard(data.storage, 'storage');
                updateCard(data.keyvault, 'keyvault');

                // Handle VM card visibility and update
                const vmCard = document.getElementById('vm-card');
                if (data.vm) {
                    vmCard.classList.remove('hidden');
                    updateCard(data.vm, 'vm');
                } else {
                    vmCard.classList.add('hidden');
                }

                // Update Overall App Status Badge
                const badge = document.getElementById('app-status-badge');
                if (data.overall === 'healthy') {
                    badge.textContent = 'App Online';
                    badge.className = 'inline-flex items-center rounded-full bg-emerald-100 px-2.5 py-0.5 text-xs font-medium text-emerald-700';
                } else {
                    badge.textContent = 'Services Degraded';
                    badge.className = 'inline-flex items-center rounded-full bg-red-100 px-2.5 py-0.5 text-xs font-medium text-red-800';
                }

            } catch (error) {
                console.error('Failed to fetch health status', error);

                // Update Badge to Offline
                const badge = document.getElementById('app-status-badge');
                badge.textContent = 'Backend Offline';
                badge.className = 'inline-flex items-center rounded-full bg-gray-100 px-2.5 py-0.5 text-xs font-medium text-gray-800';

                // Helper to set error state
                const setError = (elementIdPrefix) => {
                    const statusEl = document.getElementById(`${ elementIdPrefix }-status`);
                    if (!statusEl) return; // Skip if element doesn't exist (e.g. hidden VM card)

                    statusEl.textContent = 'Connection Failed';
                    statusEl.className = 'text-2xl font-semibold text-red-600';
                    document.getElementById(`${ elementIdPrefix }-latency`).textContent = 'Check backend logs';

                    // Reset history when full, then add failure
                    if (history[elementIdPrefix].length >= SLOT_COUNT) {
                        history[elementIdPrefix] = [];
                    }
                    history[elementIdPrefix].push('down');
                    updateHeartbeat(`${ elementIdPrefix }-heartbeat`, history[elementIdPrefix]);
                };

                setError('postgres');
                setError('storage');
                setError('keyvault');
                // Only set error for VM if it was previously visible/configured
                if (!document.getElementById('vm-card').classList.contains('hidden')) {
                    setError('vm');
                }
            }
        }

        // Polling with configurable rate
        let pollInterval = null;
        let pollRate = 3000;

        function startPolling() {
            if (pollInterval) clearInterval(pollInterval);
            pollInterval = setInterval(updateStatus, pollRate);
        }

        // Custom dropdown logic
        const dropdownBtn = document.getElementById('poll-dropdown-btn');
        const dropdownMenu = document.getElementById('poll-dropdown-menu');
        const dropdownValue = document.getElementById('poll-dropdown-value');
        const pollOptions = document.querySelectorAll('.poll-option');

        const valueLabels = {
            '1000': '1s',
            '3000': '3s',
            '5000': '5s',
            '10000': '10s'
        };

        dropdownBtn.addEventListener('click', () => {
            dropdownMenu.classList.toggle('hidden');
        });

        // Close dropdown when clicking outside
        document.addEventListener('click', (e) => {
            if (!document.getElementById('poll-dropdown').contains(e.target)) {
                dropdownMenu.classList.add('hidden');
            }
        });

        pollOptions.forEach(option => {
            option.addEventListener('click', () => {
                const value = option.dataset.value;
                pollRate = parseInt(value, 10);
                dropdownValue.textContent = valueLabels[value];

                // Update selected state
                pollOptions.forEach(opt => {
                    opt.classList.remove('bg-gray-50');
                    opt.querySelector('.check-icon')?.classList.add('hidden');
                });
                option.classList.add('bg-gray-50');
                let checkIcon = option.querySelector('.check-icon');
                if (!checkIcon) {
                    checkIcon = document.createElement('span');
                    checkIcon.innerHTML = `<svg class="h-3.5 w-3.5 text-emerald-500 check-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>`;
                    option.appendChild(checkIcon.firstChild);
                } else {
                    checkIcon.classList.remove('hidden');
                }

                dropdownMenu.classList.add('hidden');
                startPolling();
            });
        });

        // Initial call and start polling
        updateStatus();
        startPolling();

        // Modal functions
        function showErrorModal(service) {
            const modal = document.getElementById('error-modal');
            const title = document.getElementById('modal-title');
            const content = document.getElementById('modal-content');

            const serviceNames = {
                postgres: 'Database (PostgreSQL)',
                storage: 'Blob Storage',
                keyvault: 'Key Vault'
            };

            title.textContent = `${ serviceNames[service] || service } - Error Details`;
            content.textContent = window.errorMessages?.[service] || 'No error details available';
            modal.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }

        function closeErrorModal() {
            const modal = document.getElementById('error-modal');
            modal.classList.add('hidden');
            document.body.style.overflow = '';
        }

        // Close modal on Escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeErrorModal();
                closeSettingsModal();
            }
        });

        // Settings Modal Functions
        async function openSettingsModal() {
            const modal = document.getElementById('settings-modal');
            const checkVmBadge = document.getElementById('setting-check-vm');
            const vmHostEl = document.getElementById('setting-vm-host');

            try {
                const response = await fetch('/api/settings');
                const settings = await response.json();

                if (settings.check_vm) {
                    checkVmBadge.textContent = 'Enabled';
                    checkVmBadge.className = 'inline-flex items-center rounded-full bg-emerald-100 px-2.5 py-0.5 text-xs font-medium text-emerald-700';
                } else {
                    checkVmBadge.textContent = 'Disabled';
                    checkVmBadge.className = 'inline-flex items-center rounded-full bg-gray-100 px-2.5 py-0.5 text-xs font-medium text-gray-800';
                }

                vmHostEl.textContent = settings.vm_host || 'Not configured';

            } catch (error) {
                console.error('Failed to load settings', error);
            }

            modal.classList.remove('hidden');
        }

        function closeSettingsModal() {
            const modal = document.getElementById('settings-modal');
            modal.classList.add('hidden');
        }

        // Fetch and render Azure resources list
        async function loadResources() {
            const container = document.getElementById('resources-list');
            try {
                const response = await fetch('/api/resources');
                const resources = await response.json();

                if (resources.length === 0) {
                    container.innerHTML = '<div class="px-6 py-8 text-center text-sm text-gray-500">No resources configured.</div>';
                    return;
                }

                const typeIcons = {
                    postgres: `<svg class="h-5 w-5 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4m0 5c0 2.21-3.582 4-8 4s-8-1.79-8-4"/></svg>`,
                    storage: `<svg class="h-5 w-5 text-amber-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4"/></svg>`,
                    keyvault: `<svg class="h-5 w-5 text-emerald-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z"/></svg>`,
                    vm: `<svg class="h-5 w-5 text-purple-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M5 12h14M5 12a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v4a2 2 0 01-2 2M5 12a2 2 0 00-2 2v4a2 2 0 002 2h14a2 2 0 002-2v-4a2 2 0 00-2-2m-2-4h.01M17 16h.01"/></svg>`
                };

                const typeLabels = {
                    postgres: 'PostgreSQL',
                    storage: 'Blob Storage',
                    keyvault: 'Key Vault',
                    vm: 'Virtual Machine'
                };

                container.innerHTML = resources.map(r => `
                    <div class="flex items-center gap-4 px-6 py-4 hover:bg-gray-50 transition-colors">
                        <div class="flex-shrink-0">
                            ${ typeIcons[r.type] || '<div class="h-5 w-5 rounded bg-gray-200"></div>' }
                        </div>
                        <div class="min-w-0 flex-1">
                            <p class="text-sm font-medium text-gray-900 truncate">${ r.name }</p>
                            <p class="text-xs text-gray-500">${ typeLabels[r.type] || r.type }</p>
                        </div>
                        <div class="flex-shrink-0">
                            <span class="inline-flex items-center rounded-full ${ r.configured ? 'bg-emerald-100 text-emerald-700' : 'bg-gray-100 text-gray-600' } px-2 py-0.5 text-xs font-medium">
                                ${ r.configured ? 'Configured' : 'Not Set' }
                            </span>
                        </div>
                    </div>
                `).join('');

            } catch (error) {
                console.error('Failed to fetch resources', error);
                container.innerHTML = '<div class="px-6 py-8 text-center text-sm text-red-500">Failed to load resources.</div>';
            }
        }

        // Load resources on page load
        loadResources();
    </script>
</body>

</html>